<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®åº“æ£€æŸ¥</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      color: #388e3c;
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Supabase æ•°æ®åº“æ£€æŸ¥å·¥å…·</h1>
  
  <div class="section">
    <h2>1. è¿æ¥çŠ¶æ€</h2>
    <button onclick="checkConnection()">æ£€æŸ¥è¿æ¥</button>
    <div id="connectionResult"></div>
  </div>

  <div class="section">
    <h2>2. ç”¨æˆ·çŠ¶æ€</h2>
    <button onclick="checkUser()">æ£€æŸ¥å½“å‰ç”¨æˆ·</button>
    <div id="userResult"></div>
  </div>

  <div class="section">
    <h2>3. æ•°æ®åº“è¡¨æ£€æŸ¥</h2>
    <button onclick="checkTable()">æ£€æŸ¥ user_records è¡¨</button>
    <button onclick="createTable()">åˆ›å»ºè¡¨ï¼ˆSQLï¼‰</button>
    <div id="tableResult"></div>
  </div>

  <div class="section">
    <h2>4. æµ‹è¯•æ•°æ®æ“ä½œ</h2>
    <button onclick="testInsert()">æµ‹è¯•æ’å…¥æ•°æ®</button>
    <button onclick="testQuery()">æµ‹è¯•æŸ¥è¯¢æ•°æ®</button>
    <div id="dataResult"></div>
  </div>

  <script>
    const supabaseUrl = 'https://yospqbbeykizesujlhiq.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvc3BxYmJleWtpemVzdWpsaGlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTY1MTcsImV4cCI6MjA4NjU3MjUxN30.gE1rm3hpyV-_NVIPCch0hYG29OyxBGY2jzshVizPAZc'
    
    const { createClient } = supabase
    const supabaseClient = createClient(supabaseUrl, supabaseKey)

    async function checkConnection() {
      const result = document.getElementById('connectionResult')
      result.innerHTML = '<p>æ£€æŸ¥ä¸­...</p>'
      
      try {
        const { data, error } = await supabaseClient.auth.getSession()
        if (error) throw error
        
        result.innerHTML = `
          <div class="success">
            âœ… Supabase è¿æ¥æˆåŠŸï¼
            <pre>${JSON.stringify({ url: supabaseUrl, connected: true }, null, 2)}</pre>
          </div>
        `
      } catch (err) {
        result.innerHTML = `
          <div class="error">
            âŒ è¿æ¥å¤±è´¥: ${err.message}
            <pre>${JSON.stringify(err, null, 2)}</pre>
          </div>
        `
      }
    }

    async function checkUser() {
      const result = document.getElementById('userResult')
      result.innerHTML = '<p>æ£€æŸ¥ä¸­...</p>'
      
      try {
        const { data: { user }, error } = await supabaseClient.auth.getUser()
        
        if (error) throw error
        
        if (user) {
          result.innerHTML = `
            <div class="success">
              âœ… å·²ç™»å½•
              <pre>${JSON.stringify(user, null, 2)}</pre>
            </div>
          `
        } else {
          result.innerHTML = `
            <div class="error">
              âš ï¸ æœªç™»å½•ï¼Œè¯·å…ˆåœ¨ä¸»é¡µç™»å½•
            </div>
          `
        }
      } catch (err) {
        result.innerHTML = `
          <div class="error">
            âŒ æ£€æŸ¥å¤±è´¥: ${err.message}
          </div>
        `
      }
    }

    async function checkTable() {
      const result = document.getElementById('tableResult')
      result.innerHTML = '<p>æ£€æŸ¥ä¸­...</p>'
      
      try {
        // å°è¯•æŸ¥è¯¢è¡¨
        const { data, error, count } = await supabaseClient
          .from('user_records')
          .select('*', { count: 'exact', head: true })
        
        if (error) {
          if (error.code === '42P01') {
            result.innerHTML = `
              <div class="error">
                âŒ è¡¨ 'user_records' ä¸å­˜åœ¨ï¼
                <p>è¯·ç‚¹å‡»"åˆ›å»ºè¡¨ï¼ˆSQLï¼‰"æŒ‰é’®æŸ¥çœ‹å»ºè¡¨è¯­å¥ï¼Œç„¶ååœ¨ Supabase Dashboard ä¸­æ‰§è¡Œã€‚</p>
              </div>
            `
          } else {
            throw error
          }
        } else {
          result.innerHTML = `
            <div class="success">
              âœ… è¡¨ 'user_records' å­˜åœ¨ï¼
              <p>å½“å‰è®°å½•æ•°: ${count || 0}</p>
            </div>
          `
        }
      } catch (err) {
        result.innerHTML = `
          <div class="error">
            âŒ æ£€æŸ¥å¤±è´¥: ${err.message}
            <pre>${JSON.stringify(err, null, 2)}</pre>
          </div>
        `
      }
    }

    function createTable() {
      const result = document.getElementById('tableResult')
      result.innerHTML = `
        <div class="success">
          <h3>ğŸ“‹ è¯·åœ¨ Supabase Dashboard æ‰§è¡Œä»¥ä¸‹ SQLï¼š</h3>
          <p>1. æ‰“å¼€ <a href="https://supabase.com/dashboard/project/yospqbbeykizesujlhiq/editor" target="_blank">Supabase SQL Editor</a></p>
          <p>2. å¤åˆ¶ä¸‹é¢çš„ SQL å¹¶æ‰§è¡Œï¼š</p>
          <pre style="background: #263238; color: #aed581; padding: 15px; border-radius: 4px; font-size: 12px;">
-- åˆ›å»ºç”¨æˆ·æµ‹è¯•è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS user_records (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  main_type TEXT NOT NULL,
  constitution_id TEXT NOT NULL,
  scores JSONB,
  adjustment_level TEXT,
  details JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_records_user_id ON user_records(user_id);
CREATE INDEX IF NOT EXISTS idx_user_records_created_at ON user_records(created_at DESC);

-- å¯ç”¨ RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰
ALTER TABLE user_records ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®°å½•
CREATE POLICY "Users can view own records"
  ON user_records FOR SELECT
  USING (auth.uid() = user_id);

-- åˆ›å»º RLS ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„è®°å½•
CREATE POLICY "Users can insert own records"
  ON user_records FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- åˆ›å»º RLS ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„è®°å½•
CREATE POLICY "Users can delete own records"
  ON user_records FOR DELETE
  USING (auth.uid() = user_id);
          </pre>
          <p>3. æ‰§è¡ŒæˆåŠŸåï¼Œç‚¹å‡»"æ£€æŸ¥ user_records è¡¨"æŒ‰é’®éªŒè¯</p>
        </div>
      `
    }

    async function testInsert() {
      const result = document.getElementById('dataResult')
      result.innerHTML = '<p>æµ‹è¯•ä¸­...</p>'
      
      try {
        const { data: { user } } = await supabaseClient.auth.getUser()
        
        if (!user) {
          result.innerHTML = `
            <div class="error">
              âš ï¸ è¯·å…ˆç™»å½•æ‰èƒ½æµ‹è¯•æ’å…¥æ•°æ®
            </div>
          `
          return
        }

        const testData = {
          user_id: user.id,
          main_type: 'æµ‹è¯•ä½“è´¨',
          constitution_id: 'test',
          scores: { test: 100 },
          adjustment_level: 'mild',
          details: {
            description: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è®°å½•',
            timestamp: new Date().toISOString()
          }
        }

        const { data, error } = await supabaseClient
          .from('user_records')
          .insert(testData)
          .select()

        if (error) throw error

        result.innerHTML = `
          <div class="success">
            âœ… æ’å…¥æˆåŠŸï¼
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>
        `
      } catch (err) {
        result.innerHTML = `
          <div class="error">
            âŒ æ’å…¥å¤±è´¥: ${err.message}
            <pre>${JSON.stringify(err, null, 2)}</pre>
          </div>
        `
      }
    }

    async function testQuery() {
      const result = document.getElementById('dataResult')
      result.innerHTML = '<p>æŸ¥è¯¢ä¸­...</p>'
      
      try {
        const { data: { user } } = await supabaseClient.auth.getUser()
        
        if (!user) {
          result.innerHTML = `
            <div class="error">
              âš ï¸ è¯·å…ˆç™»å½•æ‰èƒ½æŸ¥è¯¢æ•°æ®
            </div>
          `
          return
        }

        const { data, error } = await supabaseClient
          .from('user_records')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })

        if (error) throw error

        result.innerHTML = `
          <div class="success">
            âœ… æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ${data.length} æ¡è®°å½•
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>
        `
      } catch (err) {
        result.innerHTML = `
          <div class="error">
            âŒ æŸ¥è¯¢å¤±è´¥: ${err.message}
            <pre>${JSON.stringify(err, null, 2)}</pre>
          </div>
        `
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è¿æ¥
    window.addEventListener('load', () => {
      checkConnection()
    })
  </script>
</body>
</html>

