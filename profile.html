<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„æ¡£æ¡ˆ Â· ä¹è´¨äº‘æµ‹</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['"Noto Serif SC"', 'Songti SC', 'serif'],
            sans: ['"Noto Sans SC"', 'PingFang SC', 'sans-serif'],
          },
          colors: {
            paper: '#f5f2eb',
            mist: '#e8eae6',
            ink: '#2c3e50',
            indigo: '#4a5568',
            ochre: '#a67c52',
            warm: '#c4a77d',
          },
        },
      },
    };
  </script>
  <style>
    :root {
      --paper: #f5f2eb;
      --mist: #e8eae6;
      --ink: #2c3e50;
      --indigo: #4a5568;
      --ochre: #a67c52;
      --warm: #c4a77d;
    }
    body { font-family: 'Noto Sans SC', sans-serif; background: var(--paper); color: var(--ink); }
    .font-serif { font-family: 'Noto Serif SC', serif; }
    .energy-ring { stroke-dasharray: 0 283; transition: stroke-dasharray 0.5s ease; }
    .card-question { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeIn {
      animation: fadeIn 0.6s ease-out;
    }
  </style>
</head>
<body class="antialiased">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-paper/95 backdrop-blur border-b border-stone-200/80">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2">
        <span class="w-9 h-9 rounded-full bg-indigo/10 flex items-center justify-center text-indigo font-serif text-lg">æµ‹</span>
        <span class="font-serif font-semibold text-ink hidden sm:inline">ä¹è´¨äº‘æµ‹</span>
      </a>
      <nav class="flex items-center gap-6 text-sm text-indigo">
        <a href="index.html" class="hover:text-ochre transition">é¦–é¡µ</a>
        <a href="index.html#test" class="hover:text-ochre transition">ä½“è´¨æµ‹è¯•</a>
        <a href="profile.html" class="text-ochre">æˆ‘çš„æ¡£æ¡ˆ</a>
        <!-- è®¿é—®é‡ç»Ÿè®¡ -->
        <span class="flex items-center gap-1.5 text-xs text-stone-500">
          <span>è®¿å®¢é‡:</span>
          <span class="visit-count font-medium text-ochre">0</span>
        </span>
      </nav>
      <div id="userNav" class="flex items-center gap-3">
        <!-- ç”± auth.js åŠ¨æ€å¡«å…… -->
      </div>
    </div>
  </header>

  <main class="pt-24 pb-16">
    <div class="max-w-4xl mx-auto px-4">
      <!-- æ¬¢è¿æç¤ºï¼ˆæ–°ç”¨æˆ·ï¼‰ -->
      <div id="welcomeMessage" class="hidden bg-gradient-to-r from-ochre/10 to-warm/10 rounded-2xl p-6 border-2 border-ochre/30 mb-8 animate-fadeIn">
        <div class="flex items-start gap-4">
          <div class="text-4xl">ğŸ‰</div>
          <div class="flex-1">
            <h2 class="font-serif text-xl text-ink mb-2">æ¬¢è¿åŠ å…¥ä¹è´¨äº‘æµ‹ï¼</h2>
            <p class="text-indigo/80 mb-4">æ‚¨å·²æˆåŠŸæ³¨å†Œï¼Œç°åœ¨å¯ä»¥å¼€å§‹æ‚¨çš„å¥åº·å…»ç”Ÿä¹‹æ—…äº†ã€‚</p>
            <div class="flex gap-3">
              <a href="index.html#test" class="inline-block px-4 py-2 rounded-full bg-ochre text-white text-sm hover:bg-ochre/90 transition">
                ç«‹å³å¼€å§‹ä½“è´¨æµ‹è¯•
              </a>
              <button onclick="document.getElementById('welcomeMessage').style.display='none'" class="px-4 py-2 rounded-full border border-stone-300 text-indigo text-sm hover:bg-mist transition">
                æˆ‘çŸ¥é“äº†
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
      <div class="bg-mist/60 rounded-2xl p-8 border border-stone-200/60 mb-8">
        <div class="flex items-start gap-6 mb-6">
          <div id="userAvatar" class="w-20 h-20 rounded-full bg-ochre/20 flex items-center justify-center text-ochre font-serif text-3xl flex-shrink-0">
            U
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-3 mb-2">
              <h1 class="font-serif text-2xl text-ink" id="userName">ç”¨æˆ·å</h1>
              <span id="userNickname" class="text-sm text-indigo/60 hidden"></span>
              <span id="userGenderIcon" class="text-lg hidden"></span>
            </div>
            <p class="text-indigo/80 text-sm mb-1" id="userEmail">ç”¨æˆ·ID</p>
            <p class="text-indigo/80 text-sm mb-2" id="userPhone">æ³¨å†Œæ—¶é—´</p>
            <p id="userBio" class="text-sm text-indigo/70 italic hidden mt-2"></p>
          </div>
          <button id="editProfileBtn" class="px-4 py-2 rounded-full border-2 border-ochre text-ochre hover:bg-ochre hover:text-white transition flex-shrink-0">
            ç¼–è¾‘èµ„æ–™
          </button>
        </div>
        <div class="grid grid-cols-3 gap-4 pt-6 border-t border-stone-200">
          <div class="text-center">
            <p class="text-2xl font-semibold text-ochre" id="testCount">0</p>
            <p class="text-sm text-indigo/70 mt-1">æµ‹è¯•æ¬¡æ•°</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-semibold text-ochre" id="joinDays">0</p>
            <p class="text-sm text-indigo/70 mt-1">åŠ å…¥å¤©æ•°</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-semibold text-ochre" id="lastTestDays">-</p>
            <p class="text-sm text-indigo/70 mt-1">ä¸Šæ¬¡æµ‹è¯•</p>
          </div>
        </div>
      </div>

      <!-- æµ‹è¯•è®°å½• -->
      <div id="testRecords" class="bg-paper rounded-2xl border border-stone-200/60 overflow-hidden scroll-mt-24">
        <div class="p-6 border-b border-stone-200/60">
          <h2 class="font-serif text-xl text-ink">æˆ‘çš„æµ‹è¯•è®°å½•</h2>
        </div>
        <div id="testRecordsContent" class="divide-y divide-stone-200/60">
          <!-- ç”± JavaScript åŠ¨æ€å¡«å…… -->
        </div>
      </div>
    </div>
  </main>

  <!-- ç¼–è¾‘èµ„æ–™å¼¹çª— -->
  <div id="editModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-paper rounded-2xl max-w-md w-full shadow-2xl">
      <div class="p-6 border-b border-stone-200/60">
        <div class="flex items-center justify-between">
          <h3 class="font-serif text-xl text-ink">ç¼–è¾‘ä¸ªäººèµ„æ–™</h3>
          <button onclick="closeEditModal()" class="w-8 h-8 rounded-full hover:bg-stone-200 flex items-center justify-center text-stone-600 transition">
            âœ•
          </button>
        </div>
      </div>
      <form id="editForm" class="p-6 space-y-4">
        <!-- ç”¨æˆ·å -->
        <div>
          <label for="editUsername" class="block text-sm font-medium text-ink mb-2">ç”¨æˆ·å</label>
          <input 
            type="text" 
            id="editUsername" 
            class="w-full px-4 py-3 rounded-xl border-2 border-stone-200 bg-white/80 text-ink outline-none focus:border-ochre transition"
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
            required
          />
          <p class="text-xs text-red-500 mt-1 hidden" id="editUsernameError"></p>
        </div>

        <!-- æ˜µç§°ï¼ˆå¯é€‰ï¼‰ -->
        <div>
          <label for="editNickname" class="block text-sm font-medium text-ink mb-2">æ˜µç§°ï¼ˆå¯é€‰ï¼‰</label>
          <input 
            type="text" 
            id="editNickname" 
            class="w-full px-4 py-3 rounded-xl border-2 border-stone-200 bg-white/80 text-ink outline-none focus:border-ochre transition"
            placeholder="è¯·è¾“å…¥æ˜µç§°"
          />
        </div>

        <!-- æ€§åˆ« -->
        <div>
          <label class="block text-sm font-medium text-ink mb-2">æ€§åˆ«</label>
          <div class="flex gap-4">
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="editGender" value="male" class="mr-2" />
              <span class="text-indigo">ç”·</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="editGender" value="female" class="mr-2" />
              <span class="text-indigo">å¥³</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="editGender" value="other" class="mr-2" checked />
              <span class="text-indigo">ä¿å¯†</span>
            </label>
          </div>
        </div>

        <!-- ç”Ÿæ—¥ï¼ˆå¯é€‰ï¼‰ -->
        <div>
          <label for="editBirthday" class="block text-sm font-medium text-ink mb-2">ç”Ÿæ—¥ï¼ˆå¯é€‰ï¼‰</label>
          <input 
            type="date" 
            id="editBirthday" 
            class="w-full px-4 py-3 rounded-xl border-2 border-stone-200 bg-white/80 text-ink outline-none focus:border-ochre transition"
          />
        </div>

        <!-- ä¸ªäººç®€ä»‹ï¼ˆå¯é€‰ï¼‰ -->
        <div>
          <label for="editBio" class="block text-sm font-medium text-ink mb-2">ä¸ªäººç®€ä»‹ï¼ˆå¯é€‰ï¼‰</label>
          <textarea 
            id="editBio" 
            rows="3"
            class="w-full px-4 py-3 rounded-xl border-2 border-stone-200 bg-white/80 text-ink outline-none focus:border-ochre transition resize-none"
            placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§..."
          ></textarea>
        </div>

        <!-- æŒ‰é’® -->
        <div class="flex gap-3 pt-4">
          <button 
            type="submit" 
            class="flex-1 py-3 rounded-xl bg-ochre text-white font-medium hover:bg-ochre/90 transition"
          >
            ä¿å­˜ä¿®æ”¹
          </button>
          <button 
            type="button" 
            onclick="closeEditModal()"
            class="px-6 py-3 rounded-xl border-2 border-stone-300 text-indigo hover:bg-mist transition"
          >
            å–æ¶ˆ
          </button>
        </div>
      </form>
    </div>
  </div>

  <footer class="border-t border-stone-200/80 bg-paper py-12">
    <div class="max-w-6xl mx-auto px-4">
      <p class="text-xs text-stone-500 text-center max-w-xl mx-auto mb-6">
        å…è´£å£°æ˜ï¼šæœ¬æµ‹è¯•ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸ä½œä¸ºåŒ»ç–—è¯Šæ–­ä¾æ®ã€‚å¦‚æœ‰èº«ä½“ä¸é€‚è¯·åŠæ—¶å°±åŒ»ã€‚
      </p>
      <div class="flex justify-center gap-6 text-sm text-indigo/80">
        <a href="#" class="hover:text-ochre">å¸®åŠ©ä¸­å¿ƒ</a>
        <a href="#" class="hover:text-ochre">å…³äºæˆ‘ä»¬</a>
      </div>
    </div>
  </footer>

  <script src="data.js"></script>
  <script src="visit-counter.js"></script>
  <script src="auth.js"></script>
  <script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const currentUser = window.JiuzhiAuth.getCurrentUser();
    if (!currentUser) {
      alert('è¯·å…ˆç™»å½•');
      window.location.href = 'login.html';
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ³¨å†Œç”¨æˆ·ï¼ˆç™»å½•æ—¶é—´åœ¨5ç§’å†…ï¼‰
    const loginTime = new Date(currentUser.loginTime);
    const now = new Date();
    const timeDiff = (now - loginTime) / 1000; // ç§’
    if (timeDiff < 5) {
      // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
      document.getElementById('welcomeMessage').classList.remove('hidden');
    }

    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
    document.getElementById('userName').textContent = currentUser.username;
    document.getElementById('userEmail').textContent = 'ç”¨æˆ·ID: ' + currentUser.id;
    document.getElementById('userPhone').textContent = 'æ³¨å†Œæ—¶é—´: ' + new Date(currentUser.loginTime).toLocaleDateString('zh-CN');

    // è·å–å®Œæ•´ç”¨æˆ·æ•°æ®
    const usersData = localStorage.getItem('jiuzhi_users');
    const users = usersData ? JSON.parse(usersData) : [];
    const fullUser = users.find(u => u.id === currentUser.id);

    if (fullUser) {
      // æ˜¾ç¤ºæ˜µç§°
      if (fullUser.nickname) {
        const nicknameEl = document.getElementById('userNickname');
        nicknameEl.textContent = `(${fullUser.nickname})`;
        nicknameEl.classList.remove('hidden');
      }
      
      // æ˜¾ç¤ºæ€§åˆ«å›¾æ ‡
      if (fullUser.gender) {
        const genderIcon = document.getElementById('userGenderIcon');
        if (fullUser.gender === 'male') {
          genderIcon.textContent = 'â™‚';
          genderIcon.style.color = '#3b82f6';
        } else if (fullUser.gender === 'female') {
          genderIcon.textContent = 'â™€';
          genderIcon.style.color = '#ec4899';
        }
        if (fullUser.gender !== 'other') {
          genderIcon.classList.remove('hidden');
        }
      }
      
      // æ˜¾ç¤ºä¸ªäººç®€ä»‹
      if (fullUser.bio) {
        const bioEl = document.getElementById('userBio');
        bioEl.textContent = `"${fullUser.bio}"`;
        bioEl.classList.remove('hidden');
      }

      // è®¡ç®—åŠ å…¥å¤©æ•°
      const joinDate = new Date(fullUser.createdAt);
      const today = new Date();
      const daysDiff = Math.floor((today - joinDate) / (1000 * 60 * 60 * 24));
      document.getElementById('joinDays').textContent = daysDiff;

      // æµ‹è¯•è®°å½•
      const testResults = fullUser.testResults || [];
      document.getElementById('testCount').textContent = testResults.length;

      // ä¸Šæ¬¡æµ‹è¯•æ—¶é—´
      if (testResults.length > 0) {
        const lastTest = new Date(testResults[testResults.length - 1].timestamp);
        const lastTestDays = Math.floor((today - lastTest) / (1000 * 60 * 60 * 24));
        document.getElementById('lastTestDays').textContent = lastTestDays === 0 ? 'ä»Šå¤©' : `${lastTestDays}å¤©å‰`;

        // æ˜¾ç¤ºæµ‹è¯•è®°å½•
        const recordsHtml = testResults.reverse().map((result, index) => {
          const testDate = new Date(result.timestamp);
          const dateStr = testDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
          const actualIndex = testResults.length - index - 1;
          
          return `
            <div class="p-6 hover:bg-mist/30 transition">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h3 class="font-medium text-ink mb-1">ç¬¬ ${testResults.length - index} æ¬¡æµ‹è¯•</h3>
                  <p class="text-sm text-indigo/70">${dateStr}</p>
                </div>
                <span class="px-4 py-1 rounded-full bg-ochre/15 text-ochre font-medium">${result.constitution}</span>
              </div>
              <p class="text-sm text-indigo/80 mb-3">${result.description ? result.description.substring(0, 100) + '...' : 'ä½“è´¨æµ‹è¯•ç»“æœ'}</p>
              <div class="flex gap-3">
                <button class="text-sm text-ochre hover:underline" onclick="viewTestDetail(${actualIndex})">æŸ¥çœ‹è¯¦æƒ…</button>
                <button class="text-sm text-indigo/70 hover:text-ochre" onclick="retakeTest()">é‡æ–°æµ‹è¯•</button>
              </div>
            </div>
          `;
        }).join('');
        
        document.getElementById('testRecordsContent').innerHTML = recordsHtml;
      } else {
        document.getElementById('lastTestDays').textContent = '-';
        document.getElementById('testRecordsContent').innerHTML = `
          <div class="p-12 text-center">
            <p class="text-indigo/60 mb-4">æ‚¨è¿˜æ²¡æœ‰è¿›è¡Œè¿‡ä½“è´¨æµ‹è¯•</p>
            <a href="index.html#test" class="inline-block px-6 py-2 rounded-full bg-ochre text-white hover:bg-ochre/90 transition">
              ç«‹å³æµ‹è¯•
            </a>
          </div>
        `;
      }
    }

    // æ›´æ–°å¯¼èˆªæ 
    const navUserArea = document.getElementById('userNav');
    if (navUserArea && currentUser) {
      navUserArea.innerHTML = `
        <div class="relative">
          <button id="userMenuBtn" class="flex items-center gap-2 text-sm text-indigo hover:text-ochre transition">
            <span class="w-8 h-8 rounded-full bg-ochre/20 flex items-center justify-center text-ochre font-medium">
              ${currentUser.username.charAt(0).toUpperCase()}
            </span>
            <span>${currentUser.username}</span>
          </button>
          <div id="userMenuDropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-paper border border-stone-200 rounded-xl shadow-lg py-2 z-50">
            <a href="profile.html" class="block px-4 py-2 text-sm text-indigo hover:bg-mist transition">æˆ‘çš„æ¡£æ¡ˆ</a>
            <a href="profile.html#testRecords" class="block px-4 py-2 text-sm text-indigo hover:bg-mist transition">æµ‹è¯•è®°å½•</a>
            <button onclick="document.getElementById('editProfileBtn').click(); document.getElementById('userMenuDropdown').classList.add('hidden');" class="w-full text-left block px-4 py-2 text-sm text-indigo hover:bg-mist transition">è´¦å·è®¾ç½®</button>
            <hr class="my-2 border-stone-200" />
            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-500 hover:bg-mist transition">é€€å‡ºç™»å½•</a>
          </div>
        </div>
      `;

      // ç»‘å®šç‚¹å‡»äº‹ä»¶æ˜¾ç¤º/éšè—èœå•
      const userMenuBtn = document.getElementById('userMenuBtn');
      const userMenuDropdown = document.getElementById('userMenuDropdown');
      
      if (userMenuBtn && userMenuDropdown) {
        userMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          userMenuDropdown.classList.toggle('hidden');
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', function(e) {
          if (!userMenuDropdown.contains(e.target) && e.target !== userMenuBtn) {
            userMenuDropdown.classList.add('hidden');
          }
        });
      }

      // ç»‘å®šé€€å‡ºç™»å½•
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
          window.JiuzhiAuth.logout();
          window.location.href = 'index.html';
        }
      });
    }

    // æŸ¥çœ‹æµ‹è¯•è¯¦æƒ…
    function viewTestDetail(index) {
      const result = fullUser.testResults[index];
      if (!result) {
        alert('æµ‹è¯•ç»“æœä¸å­˜åœ¨');
        return;
      }
      
      showTestDetailModal(result);
    }

    // æ˜¾ç¤ºæµ‹è¯•è¯¦æƒ…å¼¹çª—
    function showTestDetailModal(result) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto';
      
      const testDate = new Date(result.timestamp);
      const dateStr = testDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      
      // ç”Ÿæˆäº§å“åˆ—è¡¨HTML
      const productsHtml = result.products ? result.products.map((p, idx) => `
        <div class="bg-white rounded-xl p-4 border border-stone-200">
          <div class="flex flex-wrap gap-1 mb-3">
            ${(p.tags || []).map(t => `<span class="text-xs px-2 py-0.5 rounded-full bg-ochre/15 text-ochre">${t}</span>`).join('')}
          </div>
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
              <p class="text-xs text-stone-500 mb-1">é€šç”¨äº§å“</p>
              <h5 class="font-medium text-ink text-sm">${p.common.name}</h5>
              <p class="text-xs text-indigo/70 mt-1">${p.common.desc}</p>
            </div>
            <div class="border-l-2 border-ochre/30 pl-4">
              <p class="text-xs text-ochre font-medium mb-1">ç”˜è‚ƒç‰¹äº§ â­</p>
              <h5 class="font-medium text-ink text-sm">${p.gansu.name}</h5>
              <p class="text-xs text-indigo/70 mt-1">${p.gansu.desc}</p>
            </div>
          </div>
          ${p.recipe ? `
          <button onclick="showRecipeInDetail(${idx})" class="text-xs text-ochre hover:underline">æŸ¥çœ‹é£Ÿè°±ï¼š${p.recipe.name}</button>
          ` : ''}
        </div>
      `).join('') : '<p class="text-sm text-indigo/60">æš‚æ— äº§å“æ¨è</p>';
      
      modal.innerHTML = `
        <div class="bg-paper rounded-2xl max-w-4xl w-full my-8 shadow-2xl">
          <div class="sticky top-0 bg-ochre/10 border-b border-ochre/20 p-6 flex justify-between items-center rounded-t-2xl">
            <div>
              <h3 class="font-serif text-2xl text-ink mb-1">æµ‹è¯•è¯¦æƒ…</h3>
              <p class="text-sm text-indigo/70">${dateStr}</p>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="w-8 h-8 rounded-full bg-stone-200 hover:bg-stone-300 flex items-center justify-center text-stone-600">âœ•</button>
          </div>
          
          <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
            <!-- ä½“è´¨ç»“æœ -->
            <div class="bg-gradient-to-r from-ochre/10 to-warm/10 rounded-xl p-6 border border-ochre/20">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-serif text-xl text-ink">ä½“è´¨ç±»å‹</h4>
                <span class="px-4 py-2 rounded-full bg-ochre text-white font-medium">${result.constitution}</span>
              </div>
              ${result.secondaryConstitutions && result.secondaryConstitutions.length > 0 ? `
              <p class="text-sm text-indigo/80 mb-4">å…¼å¤¹å€¾å‘ï¼š${result.secondaryConstitutions.join('ã€')}</p>
              ` : ''}
              <p class="text-indigo/90 leading-relaxed">${result.description || ''}</p>
            </div>

            <!-- ä½“è´¨ç‰¹å¾ -->
            <div class="grid md:grid-cols-2 gap-4">
              <div class="bg-mist/60 rounded-xl p-4 border border-stone-200">
                <h5 class="font-medium text-ink mb-2 flex items-center gap-2">
                  <span class="text-ochre">ğŸ“‹</span> ç‰¹å¾è¡¨ç°
                </h5>
                <p class="text-sm text-indigo/90">${result.features || ''}</p>
              </div>
              <div class="bg-mist/60 rounded-xl p-4 border border-stone-200">
                <h5 class="font-medium text-ink mb-2 flex items-center gap-2">
                  <span class="text-ochre">ğŸ”</span> å½¢æˆåŸå› 
                </h5>
                <p class="text-sm text-indigo/90">${result.cause || ''}</p>
              </div>
            </div>

            <!-- å¥åº·é£é™© -->
            <div class="bg-red-50 rounded-xl p-4 border border-red-200">
              <h5 class="font-medium text-ink mb-2 flex items-center gap-2">
                <span class="text-red-500">âš ï¸</span> æ˜“æ‚£ç–¾ç—…
              </h5>
              <p class="text-sm text-indigo/90">${result.risks || ''}</p>
            </div>

            <!-- é£Ÿç–—æ¨è -->
            <div class="bg-green-50 rounded-xl p-4 border border-green-200">
              <h5 class="font-medium text-ink mb-3 flex items-center gap-2">
                <span class="text-green-600">ğŸ½ï¸</span> é£Ÿç–—å»ºè®®
              </h5>
              <div class="space-y-2 text-sm">
                <p class="text-indigo/90"><strong>åŸåˆ™ï¼š</strong>${result.principle || ''}</p>
                <p class="text-indigo/90"><strong>å®œé£Ÿï¼š</strong>${result.foods || ''}</p>
                <p class="text-indigo/90 bg-white rounded p-3 border border-green-100">${result.dietRecommend || ''}</p>
              </div>
            </div>

            <!-- æ¨èå†œäº§å“ -->
            <div>
              <h5 class="font-medium text-ink mb-3 flex items-center gap-2">
                <span class="text-ochre">ğŸ›’</span> æ¨èå†œäº§å“
              </h5>
              <div class="space-y-3">
                ${productsHtml}
              </div>
            </div>

            <!-- æ¨èé£Ÿè°± -->
            ${result.recipe ? `
            <div class="bg-ochre/5 rounded-xl p-4 border border-ochre/20">
              <h5 class="font-medium text-ink mb-3 flex items-center gap-2">
                <span class="text-ochre">ğŸ‘¨â€ğŸ³</span> æ¨èé£Ÿè°±
              </h5>
              <div class="bg-white rounded-lg p-4">
                <h6 class="font-medium text-ink mb-2">${result.recipe.name}</h6>
                <p class="text-sm text-indigo/80">${result.recipe.desc}</p>
              </div>
            </div>
            ` : ''}
          </div>

          <div class="p-6 border-t border-stone-200 flex gap-3">
            <button onclick="retakeTest()" class="flex-1 px-6 py-3 rounded-xl bg-ochre text-white hover:bg-ochre/90 transition">
              é‡æ–°æµ‹è¯•
            </button>
            <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 rounded-xl border-2 border-stone-300 text-indigo hover:bg-mist transition">
              å…³é—­
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      // ä¿å­˜å½“å‰ç»“æœåˆ°å…¨å±€ï¼Œä¾›é£Ÿè°±æŸ¥çœ‹ä½¿ç”¨
      window.currentTestResult = result;
    }

    // åœ¨è¯¦æƒ…ä¸­æ˜¾ç¤ºé£Ÿè°±
    window.showRecipeInDetail = function(productIndex) {
      const result = window.currentTestResult;
      if (!result || !result.products || !result.products[productIndex]) {
        alert('é£Ÿè°±ä¿¡æ¯ä¸å­˜åœ¨');
        return;
      }
      
      const product = result.products[productIndex];
      if (!product.recipe) {
        alert('è¯¥äº§å“æš‚æ— é£Ÿè°±');
        return;
      }
      
      const recipe = product.recipe;
      const recipeModal = document.createElement('div');
      recipeModal.className = 'fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50';
      recipeModal.innerHTML = `
        <div class="bg-paper rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
          <div class="sticky top-0 bg-ochre/10 border-b border-ochre/20 p-6 flex justify-between items-center">
            <h3 class="font-serif text-2xl text-ink">${recipe.name}</h3>
            <button onclick="this.closest('.fixed').remove()" class="w-8 h-8 rounded-full bg-stone-200 hover:bg-stone-300 flex items-center justify-center text-stone-600">âœ•</button>
          </div>
          <div class="p-6 space-y-6">
            <div>
              <h4 class="font-medium text-ink mb-3 flex items-center gap-2">
                <span class="text-ochre">ğŸ“</span> é£Ÿæå‡†å¤‡
              </h4>
              <ul class="space-y-2">
                ${recipe.ingredients.map(ing => `<li class="flex items-start gap-2 text-indigo/90"><span class="text-ochre">â€¢</span><span>${ing}</span></li>`).join('')}
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-ink mb-3 flex items-center gap-2">
                <span class="text-ochre">ğŸ‘¨â€ğŸ³</span> åˆ¶ä½œæ­¥éª¤
              </h4>
              <ol class="space-y-3">
                ${recipe.steps.map((step, i) => `<li class="flex gap-3"><span class="flex-shrink-0 w-6 h-6 rounded-full bg-ochre/15 text-ochre text-sm flex items-center justify-center">${i + 1}</span><span class="text-indigo/90 flex-1">${step}</span></li>`).join('')}
              </ol>
            </div>
            <div class="p-4 bg-ochre/5 rounded-xl border border-ochre/20">
              <h4 class="font-medium text-ink mb-2 flex items-center gap-2">
                <span class="text-ochre">ğŸ’¡</span> åŠŸæ•ˆè¯´æ˜
              </h4>
              <p class="text-indigo/90">${recipe.effect}</p>
            </div>
            ${recipe.tips ? `
            <div class="p-4 bg-mist/60 rounded-xl border border-stone-200/60">
              <h4 class="font-medium text-ink mb-2 flex items-center gap-2">
                <span class="text-ochre">â­</span> å°è´´å£«
              </h4>
              <p class="text-indigo/90">${recipe.tips}</p>
            </div>
            ` : ''}
            <button onclick="this.closest('.fixed').remove()" class="w-full px-6 py-3 rounded-xl border-2 border-stone-300 text-indigo hover:bg-mist transition">
              å…³é—­
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(recipeModal);
      
      recipeModal.addEventListener('click', (e) => {
        if (e.target === recipeModal) {
          recipeModal.remove();
        }
      });
    };

    // é‡æ–°æµ‹è¯•
    function retakeTest() {
      window.location.href = 'index.html#test';
    }

    // ç¼–è¾‘èµ„æ–™ - æ‰“å¼€å¼¹çª—
    document.getElementById('editProfileBtn').addEventListener('click', function() {
      openEditModal();
    });

    // æ‰“å¼€ç¼–è¾‘å¼¹çª—
    function openEditModal() {
      const modal = document.getElementById('editModal');
      
      // å¡«å……å½“å‰ç”¨æˆ·ä¿¡æ¯
      document.getElementById('editUsername').value = fullUser.username || '';
      document.getElementById('editNickname').value = fullUser.nickname || '';
      document.getElementById('editBio').value = fullUser.bio || '';
      document.getElementById('editBirthday').value = fullUser.birthday || '';
      
      // è®¾ç½®æ€§åˆ«
      const gender = fullUser.gender || 'other';
      document.querySelector(`input[name="editGender"][value="${gender}"]`).checked = true;
      
      modal.classList.remove('hidden');
    }

    // å…³é—­ç¼–è¾‘å¼¹çª—
    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
      // æ¸…é™¤é”™è¯¯æç¤º
      document.getElementById('editUsernameError').classList.add('hidden');
    }

    // ä¿å­˜ç¼–è¾‘
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const newUsername = document.getElementById('editUsername').value.trim();
      const nickname = document.getElementById('editNickname').value.trim();
      const gender = document.querySelector('input[name="editGender"]:checked').value;
      const birthday = document.getElementById('editBirthday').value;
      const bio = document.getElementById('editBio').value.trim();
      
      // éªŒè¯ç”¨æˆ·å
      if (!newUsername) {
        showEditError('editUsernameError', 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
        return;
      }
      
      if (newUsername.length < 3 || newUsername.length > 20) {
        showEditError('editUsernameError', 'ç”¨æˆ·åé•¿åº¦åº”ä¸º3-20ä¸ªå­—ç¬¦');
        return;
      }
      
      // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦è¢«å…¶ä»–ç”¨æˆ·å ç”¨
      if (newUsername !== fullUser.username) {
        const users = JSON.parse(localStorage.getItem('jiuzhi_users') || '[]');
        const exists = users.some(u => u.username === newUsername && u.id !== fullUser.id);
        if (exists) {
          showEditError('editUsernameError', 'è¯¥ç”¨æˆ·åå·²è¢«ä½¿ç”¨');
          return;
        }
      }
      
      // æ›´æ–°ç”¨æˆ·æ•°æ®
      const users = JSON.parse(localStorage.getItem('jiuzhi_users') || '[]');
      const userIndex = users.findIndex(u => u.id === fullUser.id);
      
      if (userIndex !== -1) {
        users[userIndex].username = newUsername;
        users[userIndex].nickname = nickname;
        users[userIndex].gender = gender;
        users[userIndex].birthday = birthday;
        users[userIndex].bio = bio;
        users[userIndex].updatedAt = new Date().toISOString();
        
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('jiuzhi_users', JSON.stringify(users));
        
        // æ›´æ–°å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
        const currentUserInfo = {
          id: users[userIndex].id,
          username: users[userIndex].username,
          loginTime: currentUser.loginTime
        };
        localStorage.setItem('jiuzhi_current_user', JSON.stringify(currentUserInfo));
        
        // å…³é—­å¼¹çª—å¹¶åˆ·æ–°é¡µé¢
        closeEditModal();
        alert('èµ„æ–™ä¿®æ”¹æˆåŠŸï¼');
        window.location.reload();
      }
    });

    // æ˜¾ç¤ºç¼–è¾‘é”™è¯¯
    function showEditError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });
  </script>
</body>
</html>

